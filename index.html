<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT 批量转账</title>
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh; 
            color: #fff; 
        }
        h1 { 
            font-size: 36px; 
            color: #ff8c00; 
        }
        .wallet-info { 
            margin: 10px 0; 
            font-size: 16px; 
        }
        .action-btn { 
            padding: 10px 20px; 
            font-size: 16px; 
            background: #ff8c00; 
            color: #fff; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .action-btn:hover { 
            background: #e07b00; 
        }
        .action-btn:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        .action-btn.loading { 
            opacity: 0.7; 
            pointer-events: none; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: #2d2d2d; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            color: #fff; 
            max-width: 300px; 
        }
        .modal-content p { 
            margin-bottom: 15px; 
            font-size: 16px; 
        }
        .modal-content button { 
            padding: 8px 16px; 
            background: #ff8c00; 
            color: #fff; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .nft-viewer { 
            margin-top: 20px; 
            width: 100%; 
            max-width: 600px; 
        }
        .nft-viewer h2 { 
            font-size: 24px; 
            color: #ff8c00; 
            text-align: center; 
        }
        #nftList { 
            text-align: center; 
        }
        .batch-transfer { 
            margin: 20px 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px; 
            width: 100%; 
            max-width: 400px; 
        }
        .batch-transfer label { 
            font-size: 14px; 
            color: #ff8c00; 
        }
        .batch-transfer textarea { 
            width: 100%; 
            height: 120px; 
            padding: 8px; 
            border-radius: 5px; 
            border: 1px solid #ff8c00; 
            background: #1a1a1a; 
            color: #fff; 
            font-size: 14px; 
        }
        .batch-transfer input { 
            width: 100%; 
            padding: 8px; 
            border-radius: 5px; 
            border: 1px solid #ff8c00; 
            background: #1a1a1a; 
            color: #fff; 
        }
        @media (max-width: 768px) {
            h1 { font-size: 28px; }
            .wallet-info { font-size: 14px; }
            .action-btn { padding: 8px 16px; font-size: 14px; }
            .modal-content { max-width: 90%; padding: 15px; }
            .nft-viewer h2 { font-size: 20px; }
            .batch-transfer textarea { font-size: 12px; }
            .batch-transfer input { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NFT 批量转账</h1>
        <div class="wallet-info">
            钱包地址: <span id="walletAddress">未连接</span>
        </div>
        <button id="connectWalletBtn" class="action-btn">连接钱包</button>
    </div>
    <div class="batch-transfer">
        <label for="contractAddress">NFT 合约地址:</label>
        <input type="text" id="contractAddress" placeholder="0xbf13ed020dcf22bc8216a23a1167a5dd1fdc2d0e">
        <button id="approveBtn" class="action-btn" onclick="approveContract()" disabled>授权所有 NFT</button>
        <label for="batchInput">批量转账 (每行: 地址,数量，总数最大 200):</label>
        <textarea id="batchInput" placeholder="例如：
0x394E7b6F051f0c34417d87831E156EBbbbdDA490,30
0x6d128f9717280eED5553d714972B16fdfDcC5c90,20"></textarea>
        <button id="fetchNFTsBtn" class="action-btn" onclick="fetchOwnedNFTsFromInput()" disabled>获取 NFT</button>
        <button id="batchTransferBtn" class="action-btn" onclick="batchTransferNFTs()" disabled>批量转账</button>
    </div>
    <div class="nft-viewer">
        <h2>您的 NFT</h2>
        <div id="nftList"></div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="closeModal()">确定</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, nftContract, multiCallContract, cachedTokenIds = new Set(), isApproved = false;
        const MULTICALL_CONTRACT_ADDRESS = "0xf5Ca72AA5C22C7e2B24c398090C3bcec00795424";
        const X_LAYER_CHAIN_ID = "0xc4"; // Chain ID 196
        const MAX_TOTAL_TRANSFER = 200; // 总转账数量限制
        const BATCH_FETCH_SIZE = 50; // 每次获取 tokenId 批次大小

        const ERC721_ABI = [
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"_approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}
        ];

        const MULTICALL_CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType":"address","name":"token","type":"address"},
                    {"internalType":"address[]","name":"to","type":"address[]"},
                    {"internalType":"uint256[]","name":"tokenIds","type":"uint256[]"}
                ],
                "name":"batchTransfer",
                "outputs":[],"stateMutability":"nonpayable","type":"function"
            }
        ];

        async function switchToXLayer() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: X_LAYER_CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: X_LAYER_CHAIN_ID,
                            chainName: 'X Layer mainnet',
                            nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
                            rpcUrls: ['https://xlayerrpc.okx.com'],
                            blockExplorerUrls: ['https://www.okx.com/web3/explorer/xlayer']
                        }],
                    });
                } else {
                    showModal('请切换到 X Layer 主网（Chain ID: 196）。');
                }
            }
        }

        async function checkNetwork() {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== X_LAYER_CHAIN_ID) {
                await switchToXLayer();
                const newChainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (newChainId !== X_LAYER_CHAIN_ID) {
                    showModal('请切换到 X Layer 主网（Chain ID: 196）。');
                    return false;
                }
            }
            return true;
        }

        function showModal(message) {
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        async function retryWithBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (error.message.includes('429') && i < maxRetries - 1) {
                        console.warn(`429 错误，重试 ${i + 1}/${maxRetries}，延迟 ${delay}ms`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay = Math.min(delay * 2, 8000);
                        continue;
                    }
                    throw error;
                }
            }
        }

        async function connectWallet() {
            const connectButton = document.getElementById('connectWalletBtn');
            connectButton.classList.add('loading');
            if (!window.ethereum) {
                showModal('请安装 MetaMask 钱包。');
                connectButton.classList.remove('loading');
                return;
            }
            try {
                web3 = new Web3(window.ethereum);
                if (!(await checkNetwork())) {
                    connectButton.classList.remove('loading');
                    return;
                }
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                multiCallContract = new web3.eth.Contract(MULTICALL_CONTRACT_ABI, MULTICALL_CONTRACT_ADDRESS);
                showModal('钱包已连接！');
                updateWalletAddress();
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('fetchNFTsBtn').disabled = false;
            } catch (error) {
                showModal(`连接失败: ${error.message || '未知错误'}`);
            } finally {
                connectButton.classList.remove('loading');
            }
        }

        async function updateWalletAddress() {
            if (!accounts || accounts.length === 0) {
                document.getElementById('walletAddress').innerText = '未连接';
            } else {
                document.getElementById('walletAddress').innerText = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
            }
        }

        async function approveContract() {
            if (!(await checkNetwork())) return;
            const contractAddress = document.getElementById('contractAddress').value.trim();
            if (!web3.utils.isAddress(contractAddress)) {
                showModal('无效的 NFT 合约地址！');
                return;
            }
            const approveButton = document.getElementById('approveBtn');
            approveButton.classList.add('loading');
            approveButton.disabled = true;
            try {
                nftContract = new web3.eth.Contract(ERC721_ABI, contractAddress);
                const isApprovedCheck = await retryWithBackoff(() => 
                    nftContract.methods.isApprovedForAll(accounts[0], MULTICALL_CONTRACT_ADDRESS).call()
                );
                if (isApprovedCheck) {
                    isApproved = true;
                    showModal('合约已授权！');
                    document.getElementById('fetchNFTsBtn').disabled = false;
                    document.getElementById('batchTransferBtn').disabled = true;
                } else {
                    const gasEstimate = await retryWithBackoff(() => 
                        nftContract.methods.setApprovalForAll(MULTICALL_CONTRACT_ADDRESS, true).estimateGas({ from: accounts[0] })
                    );
                    await nftContract.methods.setApprovalForAll(MULTICALL_CONTRACT_ADDRESS, true).send({ 
                        from: accounts[0], 
                        gas: Math.floor(gasEstimate * 1.2) 
                    });
                    isApproved = true;
                    showModal('授权成功！');
                    document.getElementById('fetchNFTsBtn').disabled = false;
                    document.getElementById('batchTransferBtn').disabled = true;
                }
            } catch (error) {
                showModal(`授权失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}`);
            } finally {
                approveButton.classList.remove('loading');
                approveButton.disabled = false;
            }
        }

        async function fetchOwnedNFTsFromInput() {
            if (!(await checkNetwork())) return;
            if (!web3 || !nftContract || !accounts) {
                showModal('请先连接钱包并授权！');
                return;
            }
            const contractAddress = document.getElementById('contractAddress').value.trim();
            if (!web3.utils.isAddress(contractAddress)) {
                showModal('无效的 NFT 合约地址！');
                return;
            }
            const batchInput = document.getElementById('batchInput').value.trim();
            const fetchButton = document.getElementById('fetchNFTsBtn');
            fetchButton.classList.add('loading');
            fetchButton.disabled = true;
            try {
                const lines = batchInput.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showModal('请输入至少一个地址和数量！');
                    throw new Error('输入为空');
                }
                let totalAmount = 0;
                for (const line of lines) {
                    const [address, amountStr] = line.split(',').map(item => item.trim());
                    if (!web3.utils.isAddress(address) || address === '0x0000000000000000000000000000000000000000') {
                        showModal(`无效地址: ${address}`);
                        throw new Error('无效地址');
                    }
                    const amount = parseInt(amountStr);
                    if (isNaN(amount) || amount < 1) {
                        showModal(`无效数量: ${amountStr}`);
                        throw new Error('无效数量');
                    }
                    totalAmount += amount;
                }
                if (totalAmount > MAX_TOTAL_TRANSFER) {
                    showModal(`总数超过 ${MAX_TOTAL_TRANSFER} 个 NFT！`);
                    throw new Error('总数超限');
                }
                const nftList = document.getElementById('nftList');
                nftList.innerHTML = '<p>正在加载 NFT...</p>';
                const balance = await retryWithBackoff(() => 
                    nftContract.methods.balanceOf(accounts[0]).call()
                );
                if (balance == 0) {
                    nftList.innerHTML = '<p>您没有持有任何 NFT。</p>';
                    showModal('您没有持有任何 NFT！');
                    throw new Error('无 NFT');
                }
                if (balance < totalAmount) {
                    nftList.innerHTML = `<p>您仅持有 ${balance} 个 NFT，需 ${totalAmount} 个。</p>`;
                    showModal(`NFT 不足：您有 ${balance} 个，需 ${totalAmount} 个。`);
                    throw new Error('NFT 不足');
                }
                showModal(`正在随机获取 ${totalAmount} 个 NFT...`);
                cachedTokenIds = new Set();
                const indices = Array.from({ length: balance }, (_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                let attempts = 0;
                const maxAttempts = balance * 2; // 防止无限循环
                const selectedIndices = [];
                while (selectedIndices.length < totalAmount && attempts < maxAttempts) {
                    const index = indices[Math.floor(Math.random() * indices.length)];
                    if (!selectedIndices.includes(index)) {
                        selectedIndices.push(index);
                    }
                    attempts++;
                }
                const batchSize = BATCH_FETCH_SIZE;
                for (let i = 0; i < selectedIndices.length && cachedTokenIds.size < totalAmount; i += batchSize) {
                    const batchIndices = selectedIndices.slice(i, i + batchSize);
                    const batchPromises = batchIndices.map(index => 
                        retryWithBackoff(() => 
                            nftContract.methods.tokenOfOwnerByIndex(accounts[0], index).call()
                        ).then(tokenId => 
                            retryWithBackoff(() => 
                                nftContract.methods.ownerOf(tokenId).call()
                            ).then(owner => ({ tokenId, owner }))
                        )
                    );
                    const batchResults = await Promise.all(batchPromises);
                    batchResults.forEach(({ tokenId, owner }) => {
                        if (owner.toLowerCase() === accounts[0].toLowerCase() && !cachedTokenIds.has(tokenId)) {
                            cachedTokenIds.add(tokenId);
                        }
                    });
                    nftList.innerHTML = `<p>已获取 ${cachedTokenIds.size}/${totalAmount} 个 NFT...</p>`;
                }
                if (cachedTokenIds.size < totalAmount) {
                    nftList.innerHTML = `<p>仅获取到 ${cachedTokenIds.size} 个 NFT。</p>`;
                    showModal('获取的 NFT 数量不足！');
                    throw new Error('NFT 不足');
                }
                const tokenIdArray = Array.from(cachedTokenIds);
                nftList.innerHTML = `<p>获取 ${cachedTokenIds.size} 个 NFT，示例：${tokenIdArray.slice(0, 5).join(', ')}${tokenIdArray.length > 5 ? ' 等...' : ''}</p>`;
                document.getElementById('batchTransferBtn').disabled = false;
            } catch (error) {
                showModal(`获取 NFT 失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}`);
                nftList.innerHTML = '<p>加载 NFT 失败。</p>';
            } finally {
                fetchButton.classList.remove('loading');
                fetchButton.disabled = false;
            }
        }

        async function batchTransferNFTs() {
            if (!(await checkNetwork())) return;
            if (!web3 || !nftContract || !multiCallContract || !accounts) {
                showModal('请先连接钱包并授权！');
                return;
            }
            const contractAddress = document.getElementById('contractAddress').value.trim();
            if (!web3.utils.isAddress(contractAddress)) {
                showModal('无效的 NFT 合约地址！');
                return;
            }
            const batchInput = document.getElementById('batchInput').value.trim();
            const batchButton = document.getElementById('batchTransferBtn');
            batchButton.classList.add('loading');
            batchButton.disabled = true;
            try {
                if (!isApproved) {
                    const isApprovedCheck = await retryWithBackoff(() => 
                        nftContract.methods.isApprovedForAll(accounts[0], MULTICALL_CONTRACT_ADDRESS).call()
                    );
                    if (!isApprovedCheck) {
                        showModal('请先授权 JACEMultiCall 合约！');
                        throw new Error('未授权');
                    }
                    isApproved = true;
                }
                const lines = batchInput.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showModal('请输入至少一个地址和数量！');
                    throw new Error('输入为空');
                }
                const transfers = [];
                let totalAmount = 0;
                for (const line of lines) {
                    const [address, amountStr] = line.split(',').map(item => item.trim());
                    if (!web3.utils.isAddress(address) || address === '0x0000000000000000000000000000000000000000') {
                        showModal(`无效地址: ${address}`);
                        throw new Error('无效地址');
                    }
                    const amount = parseInt(amountStr);
                    if (isNaN(amount) || amount < 1) {
                        showModal(`无效数量: ${amountStr}`);
                        throw new Error('无效数量');
                    }
                    transfers.push({ address, amount });
                    totalAmount += amount;
                }
                if (totalAmount > MAX_TOTAL_TRANSFER) {
                    showModal(`总数超过 ${MAX_TOTAL_TRANSFER} 个 NFT！`);
                    throw new Error('总数超限');
                }
                if (cachedTokenIds.size < totalAmount) {
                    showModal(`已获取 ${cachedTokenIds.size} 个 NFT，需 ${totalAmount} 个，请重新获取！`);
                    throw new Error('NFT 不足');
                }
                const toAddresses = [];
                const selectedTokenIds = [];
                const tokenIdArray = Array.from(cachedTokenIds);
                for (const { address, amount } of transfers) {
                    for (let i = 0; i < amount; i++) {
                        if (!tokenIdArray.length) {
                            showModal('NFT 数量不足！');
                            throw new Error('NFT 不足');
                        }
                        const tokenId = tokenIdArray.shift();
                        const owner = await retryWithBackoff(() => 
                            nftContract.methods.ownerOf(tokenId).call()
                        );
                        if (owner.toLowerCase() !== accounts[0].toLowerCase()) {
                            showModal(`tokenId ${tokenId} 不属于您！`);
                            throw new Error('tokenId 不属于调用者');
                        }
                        toAddresses.push(address);
                        selectedTokenIds.push(tokenId);
                        cachedTokenIds.delete(tokenId);
                    }
                }
                showModal(`正在转账 ${totalAmount} 个 NFT...`);
                const gasEstimate = await retryWithBackoff(() => 
                    multiCallContract.methods.batchTransfer(
                        contractAddress,
                        toAddresses,
                        selectedTokenIds
                    ).estimateGas({ from: accounts[0] })
                );
                await multiCallContract.methods.batchTransfer(
                    contractAddress,
                    toAddresses,
                    selectedTokenIds
                ).send({ from: accounts[0], gas: Math.floor(gasEstimate * 1.2) });
                showModal('批量转账成功！');
                document.getElementById('nftList').innerHTML = `<p>剩余 ${cachedTokenIds.size} 个 NFT，示例：${Array.from(cachedTokenIds).slice(0, 5).join(', ')}${cachedTokenIds.size > 5 ? ' 等...' : ''}</p>`;
                document.getElementById('batchTransferBtn').disabled = true;
            } catch (error) {
                showModal(`批量转账失败: ${error.message.includes('Not owner or approved') ? '部分 NFT 不属于您或未授权，请重新获取 NFT 或检查授权' : error.message.includes('non ERC721Receiver') ? '接收者地址不支持 ERC721' : error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}`);
            } finally {
                batchButton.classList.remove('loading');
                batchButton.disabled = !cachedTokenIds.size;
            }
        }

        window.onload = () => {
            if (!window.ethereum) {
                showModal('请安装 MetaMask 钱包。');
            }
        };

        window.ethereum?.on('chainChanged', () => {
            window.location.reload();
        });

        window.ethereum?.on('accountsChanged', (newAccounts) => {
            accounts = newAccounts;
            cachedTokenIds = new Set();
            isApproved = false;
            updateWalletAddress();
            if (newAccounts.length === 0) {
                document.getElementById('approveBtn').disabled = true;
                document.getElementById('fetchNFTsBtn').disabled = true;
                document.getElementById('batchTransferBtn').disabled = true;
            } else {
                connectWallet();
            }
        });

        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
    </script>
</body>
</html>
